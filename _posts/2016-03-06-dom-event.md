---
title: DOM 事件
date: 2016-03-06 22:29:59
categories: DOM
tags: Events
---
## 3.1 事件流
**事件流**描述的是从页面中接受事件的顺序

### 3.1.1 事件冒泡
IE 的事件流叫做**事件冒泡**，即事件开始时由最具体的元素（文档嵌套层次最深的那个节点）接收，然后逐级向上传播到较为不具体的节点（文档）。

- `IE9` 及以上冒泡到 window 对象

### 3.1.2 事件捕获
事件捕获的思想是不太具体的节点应该更早接收到事件，而最具体的节点应该最后接收到事件。

《JS高程》建议读者在有特殊需要时再使用事件捕获。
 
### 3.1.3 DOM 事件流
“DOM2级事件” 规定的事件流包括三个阶段：事件捕获阶段、处于目标阶段、事件冒泡阶段。

`IE9` 和其他浏览器都会在捕获阶段触发事件对象上的事件；结果，就是有两个机会在目标对象上操作事件。

<!-- more -->

## 3.2 事件处理程序
响应某个事件的函数就叫做**事件处理程序**（事件监听器）

### 3.2.1 HTML 事件处理程序
- 某个元素支持的每种事件，都可以使用一个与相应事件处理程序同名的 HTML 特性来指定；
- 这个特性的值应该是能够执行的 javascript 代码
- 在这个函数内部，this 的值等于事件的目标元素-

**在 HTML 中指定事件处理程序有三个缺点**：

- 1、存在时差问题 
- 2、这样扩展事件处理程序的作用域链在不同的浏览器中导致不同的结果
- 3、HTML 和 JavaScript 代码紧密耦合

### 3.2.2 DOM0 级事件处理程序
将一个函数赋值给一个事件处理程序属性

- 每个元素都有自己的事件处理程序属性，通常全部小写
- 使用 DOM0 级方法指定的事件处理程序被认为是元素的方法
- 事件处理程序是在元素的作用域中运行， this 引用当前元素
- 删除通过 DOM0 级方法指定的事件处理程序，只需要将事件处理程序属性值设置为 null

### 3.2.3 DOM2 级事件处理程序
两个方法

- `addEventListener()` 、 `removeEventListener()`
- 接受三个参数：要处理的事件名、作为事件处理程序的函数、一个布尔值
- true 表示在捕获阶段调用事件处理程序， false 在冒泡阶段
- `IE9` 及以上支持

### 3.2.4 IE 事件处理程序
- `attachEvent()` `detachEvent()`
- 接受两个参数：事件处理程序名称（要加上 on）与事件处理函数

**作用域问题** 在 IE 中使用 attachEvent()与使用 DOM0 级方法的主要区别在于事件处理程序的作用域。
在使用 DOM0 级方法的情况下，事件处理程序会在所属元素的作用域内运行；在使用 attachEvent() 方法的情况下，事件处理程序会在全局作用域内运行，因此 this 等于 window

**添加多个事件处理程序** 与 addEventListener() 类似，attachEvent() 方法也可以用来为一个元素添加多个事件处理程序；这些事件处理程序不是以添加它们的顺序执行，而是以相反的顺序被触发

**移除事件** 通过 detachEvent()，条件是必须提供相同的参数，添加的匿名函数不能够被移除

### 3.2.5 跨浏览器的事件处理程序

```javascript
var EventUtil = {
    addHandler:function(element, type, handler) {
        if (element.addEventListener) {
            element.addEventListener(type, handler, false);
        } else if (element.attachEvent) {
            element.attachEvent('on'+type, handler);
        } else {
            element['on'+type] = handler;
        }
    },
    removeHandler: function(element, type, handler) {
        if (element.removeEventListener) {
            element.removeEventListener(type, handler, false);
        } else if (element.detachEvent) {
            element.detachEvent('on'+type, handler);
        } else {
            element['on'+type] = null;
        }
    }
}
```

## 3.3 事件对象
在触发 DOM 上某个事件时，会产生一个事件对象 event，这个对象包含着所有与事件有关的信息。

### 3.3.1 DOM 中的事件对象
兼容 DOM 的浏览器会将一个 event 对象传入到事件处理程序中
在通过 HTML 特性指定事件处理程序时，变量 event 中保存着 event 对象

**所有事件都会有以下属性和方法**

属性 / 方法 | 类型 | 说明
--------- | -------| -------
`bubbles` | Boolean | 表明事件是否冒泡
`cancelable` | Boolean | 表明是否可以取消事件的默认行为
`currentTarget` | Element | 其事件处理程序当前正在处理事件的那个元素
`detail` | Integer | 与事件相关的细节信息
`eventPhase` | Integer | 调用事件处理程序的阶段：1 捕获，2 处于目标，3 冒泡
`preventDefault( )` | Function | 取消事件的默认行为。如果 cancelable 是 true，则可以使用这个方法
`stopImmediatePropagation( )` | Function |　取消事件的进一步捕获或冒泡，同时阻止任何事件处理程序被调用（DOM3 新增）
`stopPropagation( )` | Function | 取消事件的进一步捕获或冒泡
`target` | Element | 事件的目标
`type` | String | 被触发的事件的类型

- 在事件处理程序内部，对象 this 始终等于 currentTarget 的值，而 target 则只包含事件的实际目标。
- **注意** 用 attachEvent 指定的事件程序 this 指向 window

**通过一个函数同时处理多个事件** 使用 type 属性

```javascript
var btn = document.getElementById('mtBtn');
var handler = function(event) {
    switch(event.type) {
        case 'click':
            alert('click');
            break;
        case 'mouseover':
            alert('Mouseover');
            break;
    }
}
```

### 3.3.2 IE 中的事件对象
- 在使用 DOM0 级方法添加事件处理程序时，event 对象作为 window 对象的一个属性存在
- 如果事件处理程序是使用 attachEvent 添加的，那么就会有一个 event 对象被传入到事件处理函数程序中
- 使用 attachEvent 的情况下也可以通过 window.event 访问 event 对象
- IE 的 event 对象同样也包含与创建它的事件相关的属性和方法

属性 / 方法 | 类型 | 说明
----- | ---- | ----- 
`cancelBubble` | Boolean | 默认值为 false，将其设置为 true 就可以阻止冒泡
`returnValue` | Boolean | 默认值为 true，将其设置为 false 就可以取消事件的默认行为
`srcElement` | Element | 事件的目标（相当于 DOM 中的 target）
`type` | String | 被触发的事件的类型


- 由于 IE 不支持事件捕获，故只能取消事件冒泡

### 3.3.3 跨浏览器的事件对象

```javascript
var EventUtil = {
    getEvent:function(event) {
        return event ? event : window.event;
    },
    getTarget:function(event) {
        return event.target ? event.target : event.srcElement;
    },
    preventDefault:function(event) {
        if (event.preventDefault) {
            event.preventDefault();
        } else {
            event.returnValue = false;
        }
    },
    stopPropagation:function(event) {
        if (event.stopPropagation) {
            event.stopPropagation();
        } else {
            event.cancelBubble = true;
        }
    }
}
```

## 3.4 事件类型
- 包括 IE9 在内的所有主流浏览器都支持 DOM2 级事件。
- IE9 也支持 DOM3 级事件

### 3.4.1 UI 事件
UI 事件指的是那些不一定与用户操作相关的事件。

**1.load 事件**
当页面完全加载后（包括所有图像、JavaScript 文件、CSS 文件等外部资源），就会触发 window 上面的 load 事件。
新图像元素只要设置了 src 属性就会开始下载。
`<script>` `<link>` 设置了 src 或 href 属性后，并将其添加到文档之后才会开始下载。 

**2.unload 事件**

- 在文档完全被卸载后触发
- 
```javascript
EventUtil.addHandler(window, 'unload', function(event) {
    alert('Unload');
});
```

- 此时生成的 event 对象在兼容 DOM 的浏览器中只包含 target 属性（值为 document）；
- IE8 以下则为 srcElement。

**3.resize 事件**

- 当浏览器窗口被调整到一个新的高度或宽度时，就会触发 resize 事件
- 这个事件在 window 上触发
- target 值为 document
- Firefox 只会在用户停止调整时触发，其他浏览器会在窗口变化 1 像素时触发

**4.scroll 事件**

- scroll 事件也会在文档被滚动期间被重复触发

### 3.4.2 焦点事件
- 焦点事件会在页面元素获得或失去焦点时触发。
- 利用这些事件并与 `document.hasFocus()方法` 以及 `document.activeElement属性` 配合，可以知晓用户在页面上的行踪。

- blur：元素失去焦点时触发，不冒泡，所有浏览器支持
- DOMFocusIn：在元素获得焦点时触发，与 focus 等价，冒泡，只有 Opera 支持
- focus：在元素获得焦点时触发，不冒泡，所有浏览器支持
- focusin：在元素获得焦点时触发，与 focus 等价，冒泡，IE5.5+ 支持
- focusout：在元素失去焦点时触发，时 blur 的通用版本

当焦点从页面中一个元素移动到另外一个元素，会依次触发下列事件：
1、focusout
2、focusin
3、blur
4、DOMFocusOut
5、focus
6、DOMFocusIn

### 3.4.3 鼠标与滚轮事件
DOM3 级事件中定义了 9 个鼠标事件

- `click` 单击主鼠标按钮 或者 按下回车键时触发
- `dbclick` 双击主鼠标按钮
- `mousedown` 按下任意鼠标按钮（键盘不行）
- `mouseenter` 光标从元素外部首次移动到元素范围之内时触发，不冒泡，在光标移动到后代元素上也不会触发
- `mouseleave` 在位于元素上方的鼠标光标移动到元素范围之外时触发，不冒泡，在光标移动到后代后代元素上不会触发
- `mousemove` 当鼠标指针在元素内部移动时重复触发
- `mouseout` 鼠标在 A元素 移入另一个元素时触发。移入的另一个元素可能是A元素的外部，也可能是 A元素的子元素
- `mouseover` 在鼠标位于一个元素外部，将其首次移入一个元素边界之时触发
- `mouseup` 在用户释放鼠标按钮时触发

可以通过取消 mousedown 或 mouseup 或 click 取消 dbclick 事件！

**1.客户区坐标位置**

- clientX
- clientY

**2.页面坐标位置**

- pageX
- pageY
- 两个属性表示鼠标光标在页面上的位置，因为页面是从页面本身的左边和顶边开始计算的

IE8 以及更早版本不支持事件对象上的页面坐标，但是可以使用客户区坐标和滚动信息计算出来

```javascript
var div = document.getElementById('myDiv');
        EventUtil.addHandler(div, 'click', function(event) {
            event = EventUtil.getEvent(event);
            var pageX = event.pageX;
                    pageY = event.pageY;
            if (pageX === undefined) {
                // document.body 标准模式 
                // document.documentElement 混杂模式
                pageX = event.clientX + (document.body.scrollLeft || document.documentElement.scrollLeft);
            }

            if (pageY === undefined) {
                pageY = event.clientY + (document.body.scrollTop || document.documentElement.scrollTop);
            }
            alert( 'Page coordinates:' + pageX + ',' + pageY );
        });
```

**3.屏幕位置坐标**
鼠标事件发生时，会有一个相对于整个电脑屏幕的位置；

- screenX
- screenY

**4.修改键**

- 按下鼠标时键盘上的某些键的状态可以影响到所要采取的操作。
- 这些修改键就是 `shiftKey` `ctrlKey` `altKey` `metaKey`（Windows 或 Cmd **IE不支持**）
- 这些属性中包含的都是布尔值，按下了就是 true，否则为 false
- IE9 以上都支持前面那四个键，IE8 及以下不支持 metaKey

**5.相关元素**
B元素 包含 A元素，如果鼠标指针一开始在 A元素 上，然后移出了这个元素，那么在 A元素 上就会触发 mouseout 事件，相关元素就是 B元素；与此同时，B元素 上面会触发 mouseover 事件，而相关元素就变成了 A元素。

- `relatedTarget`属性提供相关元素的信息，这个属性只对 `mouseout` `mouseover` 才包含值，其他事件这个属性的值时 null。
- IE8 及之前不支持 relatedTarget，但 IE 提供其他的属性保存同样的值
- `fromElement` 在 mouseover 事件中提供相关元素信息
- `toElement` 在 mouseout 事件中提供相关元素信息

**6.鼠标按钮**
对于 mousedown 和 mouseup 事件来说，其 event 对象中存在一个 `button` 属性，表示按下或释放的按钮。

DOM 的 button 属性

- 0 - 主鼠标按钮
- 1 - 滚轮鼠标按钮
- 2 - 次鼠标按钮

IE8 及之前版本提供自己的 button 属性，跟 DOM 的 button 属性有很大差异
跨浏览器

```javascript
// 兼容版 getButton
var getButton = function(event) {
    if (document.implementation.hasFeature('MouseEvents', '2.0')) {
        return event.button;
    } else {
        switch(event.button) {
            case 0:
            case 1:
            case 3:
            case 5:
            case 7:
                return 0;
            case 2:
            case 6:
                return 2;
            case 4:
                return 1;
        }
    }
}
```

**7.更多的事件信息**

- `detail` 在给定位置（一点）上发生了多少次点击
- `offsetX` 光标相对于目标元素边界的 x 坐标
- `offsetY` 光标相对于目标元素边界的 y 坐标

IE 鼠标事件的属性（只有 IE 支持）

- `altLeft` 布尔值，表示是否按下了 `Alt`，如果按下了，`altKey`的值也为 true
- `ctrlLeft` 布尔值，是否按下了 `Ctrl`，同上
- `shiftLeft` 布尔值，是否按下了 `Shift` 键

**8.鼠标滚轮事件**
可以在任何元素上触发，冒泡，IE8 到 document 元素，IE9 及以上冒泡到 window 对象

- `wheelDelta 属性` 向前滚动是 120 的倍数，向后滚动是 -120 的倍数 

### 3.4.4 键盘事件与文本事件
- `keydown` 按下任意键触发，按住不放会重复触发
- `keypress` 按下字符键时触发，按住不放会重复触发
- `keyup` 释放键盘上的按键时触发，文本框发生之后触发

**跟鼠标事件一样支持一样的修改键**

**1.键码**

- 在发生 keydown 和 keyup 事件时，event 对象的 `keyCode` 属性中会包含一个代码，与键盘上一个特定的键对应。

**2.字符编码**

- 发生 keypress 事件意味着按下的键会影响到屏幕中文本的显示，在所有浏览器中，按下能够插入和删除字符的键都会触发 keypress 事件。
- charCode 属性只在发生 keypress 事件才包含值，IE9 及以上支持。

**3.DOM3 级变化**

- 不再包含 charCode 属性
- 新增 `key` 按下某个字符键时，值就是相应的文本字符；按下非字符键时，值就是相应的键名
- 新增 `char` 行为跟 `key` 相同，按下非字符键值为 null

**4.textInput 事件**

- `IE9+` 支持
- 在可编辑区域输入字符时，就会触发这个事件
- 跟 keypress 的不同点一：keypress 在任何可获得焦点的元素触发，textInput 在可编辑区域才能触发
- 不同点二：textInput 只在按下能够输入实际字符的键时触发；keypress 在按下那些能够影响文本显示的键时也能触发

